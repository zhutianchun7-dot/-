<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸´æ¸¯å·¡æ£€ç®¡ç†æ™ºæ…§çœ‹æ¿</title>
    <style>
        /* åŸºç¡€æ ·å¼ */
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; font-family: "Microsoft YaHei", sans-serif; }
        #container { width: 100%; height: 100vh; }

        /* å·¦ä¾§é¢æ¿ */
        .control-panel {
            position: absolute; top: 15px; left: 15px; z-index: 1000;
            background: rgba(255, 255, 255, 0.96); padding: 15px;
            border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            width: 240px; max-height: 85vh; overflow-y: auto;
        }
        .filter-group { margin-bottom: 12px; padding: 10px; background: #f8f9fa; border-radius: 8px; }
        .filter-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 13px; color: #444; }
        #projectSearch, select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; outline: none; }

        /* æ¨¡å¼åˆ‡æ¢æŒ‰é’® */
        .mode-switch { display: flex; gap: 5px; margin-bottom: 8px; }
        .mode-btn { flex: 1; padding: 8px 0; font-size: 12px; cursor: pointer; border: 1.5px solid #1e88e5; background: white; color: #1e88e5; border-radius: 6px; font-weight: bold; }
        .mode-btn.active { background: #1e88e5; color: white; }

        /* å›¾ä¾‹ */
        .legend { margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee; }
        .legend-item { display: flex; align-items: center; margin-bottom: 8px; font-size: 12px; color: #333; }
        .dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 10px; }
        .pin-legend { width: 12px; height: 12px; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); margin-right: 12px; display: inline-block; }

        /* æ±‡æ€»çœ‹æ¿å¼¹çª— */
        #statsModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; }
        .modal-content {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; width: 95%; max-width: 850px; max-height: 85vh;
            border-radius: 15px; padding: 20px; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #1e88e5; padding-bottom: 15px; margin-bottom: 15px; }
        .stats-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .stats-table th, .stats-table td { border-bottom: 1px solid #eee; padding: 12px; text-align: left; }
        .stats-table th { background: #f4f7f9; position: sticky; top: 0; z-index: 10; }
        .summary-bar { background: #e3f2fd; padding: 15px; margin-top: 15px; border-radius: 10px; font-weight: bold; display: flex; justify-content: space-around; color: #1565c0; }

        /* æ‚¬æµ®æŒ‰é’® */
        .open-stats-btn {
            position: absolute; bottom: 30px; right: 20px; z-index: 1000;
            background: #1e88e5; color: white; border: none; padding: 12px 25px;
            border-radius: 30px; cursor: pointer; font-size: 15px; font-weight: bold;
            box-shadow: 0 4px 15px rgba(30,136,229,0.4);
        }

        /* æ‰‹æœºé€‚é… */
        @media (max-width: 500px) {
            .control-panel { width: 160px; padding: 10px; top: 10px; left: 10px; }
            .modal-content { width: 98%; padding: 12px; }
            .summary-bar { flex-direction: column; gap: 5px; font-size: 12px; }
            .open-stats-btn { bottom: 20px; right: 10px; padding: 10px 18px; font-size: 13px; }
        }
        /* ä¼˜åŒ–åçš„ä¿¡æ¯çª—ä½“æ ·å¼ */
.info-window {
    padding: 5px;
    min-width: 220px;
}
.info-window h3 {
    margin: 0 0 12px 0;
    color: #1e88e5;
    font-size: 16px;
    border-bottom: 2px solid #e3f2fd;
    padding-bottom: 8px;
    font-weight: bold;
}
.info-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 6px; /* ç¨å¾®ç¼©å°é—´è·ï¼Œé˜²æ­¢å¼¹çª—è¿‡é«˜ */
    font-size: 13px;
}
.info-label {
    color: #666;
}
.info-value {
    color: #333;
    font-weight: bold;
}
.tag-blue {
    background: #e3f2fd;
    color: #1976d2;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 12px;
}
.address-box {
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px dashed #eee;
}
.address-text {
    display: block;
    font-size: 12px;
    color: #999;
    margin-top: 4px;
    line-height: 1.4;
}
    </style>
</head>
<body>

    <div class="control-panel">
        <h2 style="margin:0 0 10px 0; font-size:18px; color:#1e88e5;">å·¡æ£€ç®¡ç†çœ‹æ¿</h2>
        <div class="filter-group">
            <label>æœç´¢é¡¹ç›®ï¼š</label>
            <input type="text" id="projectSearch" placeholder="è¾“å…¥åç§°å¹¶å›è½¦..." onkeypress="handleSearch(event)">
        </div>
        <div class="filter-group">
            <label>å±•ç¤ºæ¨¡å¼ï¼š</label>
            <div class="mode-switch">
                <button id="btn-freq" class="mode-btn active" onclick="switchMode('frequency')">å·¡æ£€é¢‘æ¬¡ï¼ˆåœ†åœˆï¼‰</button>
                <button id="btn-man" class="mode-btn" onclick="switchMode('manager')">å·¡æ£€äººå‘˜ï¼ˆæ°´æ»´ï¼‰</button>
            </div>
        </div>
        <div class="filter-group">
            <label>åœ°å›¾ç­›é€‰ (äººå‘˜)ï¼š</label>
            <select id="managerSelect" onchange="updateDisplay()">
                <option value="å…¨éƒ¨">å…¨éƒ¨äººå‘˜</option>
            </select>
        </div>
        <div id="legendBox" class="legend"><div id="legendContent"></div></div>
    </div>

    <button class="open-stats-btn" onclick="toggleModal(true)">ğŸ“Š æ•°æ®æ±‡æ€»çœ‹æ¿</button>

    <div id="statsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin:0">å·¡æ£€ç»Ÿè®¡</h2>
                <span style="cursor:pointer; font-size:28px; color:#aaa;" onclick="toggleModal(false)">&times;</span>
            </div>
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <select id="modalManagerFilter" onchange="renderTable()"><option value="å…¨éƒ¨">æ‰€æœ‰äººå‘˜</option></select>
                <select id="modalFreqFilter" onchange="renderTable()">
                    <option value="å…¨éƒ¨">æ‰€æœ‰é¢‘æ¬¡</option>
                    <option value="2æ¬¡/æœˆ">2æ¬¡/æœˆ</option>
                    <option value="4æ¬¡/æœˆ">4æ¬¡/æœˆ</option>
                    <option value="12æ¬¡/æœˆ">12æ¬¡/æœˆ</option>
                    <option value="æ¯å¤©">æ¯å¤©</option>
                </select>
            </div>
            <table class="stats-table">
                <thead><tr><th>å®¢æˆ·åç§°</th><th>å·¡æ£€äºº</th><th>é¢‘æ¬¡</th><th>é…ç”µé—´</th><th>å˜å‹å™¨</th></tr></thead>
                <tbody id="statsTableBody"></tbody>
            </table>
            <div class="summary-bar" id="tableSummary"></div>
        </div>
    </div>

    <div id="container"></div>

    <script type="text/javascript">
        window._AMapSecurityConfig = { securityJsCode: '014ca988787237a1fbdc0a1e1ba2db9b' };
    </script>
    <script type="text/javascript" src="https://webapi.amap.com/maps?v=2.0&key=5549cbcc4a06aaa64f89f54089c4ba12"></script>

    <script>
        let currentMode = 'frequency', rawData = [], markers = [];
        let infoWindow = new AMap.InfoWindow({ offset: new AMap.Pixel(0, -15) });

        // æœ€ç»ˆç¡®å®šçš„é…è‰²æ–¹æ¡ˆ
        const freqColors = { 
            '2æ¬¡/æœˆ': '#1e88e5', // è“è‰²
            '4æ¬¡/æœˆ': '#005b96', // æ·±è“è‰² (æ¯”è“æ·±ï¼Œæ¯”çº¢æ©™å†·)
            '12æ¬¡/æœˆ': '#fb8c00', // æ©™è‰²
            'æ¯å¤©': '#e53935'    // çº¢è‰²
        };
        const managerColors = ['#E91E63', '#9C27B0', '#673AB7', '#3F51B5', '#00BCD4', '#009688', '#FF9800', '#795548'];
        let managerColorMap = {};

        const map = new AMap.Map('container', { zoom: 12, center: [121.831779,30.923848], mapStyle: 'amap://styles/normal' });

        fetch('data.json').then(res => res.json()).then(data => {
            rawData = data;
            initFilters();
            updateDisplay();
        });

        function initFilters() {
            const managers = [...new Set(rawData.map(d => d.manager))].filter(m => m && m !== 'nan');
            const select = document.getElementById('managerSelect');
            const modalSelect = document.getElementById('modalManagerFilter');
            managers.forEach((m, i) => {
                managerColorMap[m] = managerColors[i % managerColors.length];
                select.add(new Option(m, m));
                modalSelect.add(new Option(m, m));
            });
        }

        function handleSearch(e) {
            if (e.key === 'Enter') {
                const kw = e.target.value.trim().toLowerCase();
                const target = rawData.find(d => d.name.toLowerCase().includes(kw));
                if (target) { map.setZoomAndCenter(15, target.position); openPopup(target); }
            }
        }

        function openPopup(item) {
    // è‡ªåŠ¨è·å–è¯¥é¢‘æ¬¡å¯¹åº”çš„é¢œè‰²ï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…åˆ°åˆ™é»˜è®¤é»‘è‰²
    const dynamicColor = freqColors[item.frequency] || '#333';

    const content = `
        <div class="info-window">
            <h3>${item.name}</h3>
            
            <div class="info-item">
                <span class="info-label">å·¡æ£€äººå‘˜</span>
                <span class="tag-blue">${item.manager}</span>
            </div>
            
            <div class="info-item">
                <span class="info-label">å·¡æ£€é¢‘æ¬¡</span>
                <span class="info-value" style="color: ${dynamicColor};">${item.frequency}</span>
            </div>
            
            <div class="info-item">
                <span class="info-label">é…ç”µé—´æ•°é‡</span>
                <span class="info-value"><span style="color:#1e88e5;">${item.rooms}</span> é—´</span>
            </div>

            <div class="info-item">
                <span class="info-label">å˜å‹å™¨æ•°é‡</span>
                <span class="info-value"><span style="color:#1e88e5;">${item.transformers}</span> å°</span>
            </div>
            
            <div class="address-box">
                <span class="info-label" style="font-size:11px;">ğŸ“ è¯¦ç»†åœ°å€</span>
                <span class="address-text">${item.address || 'æš‚æ— è¯¦ç»†åœ°å€'}</span>
            </div>
        </div>`;
        
    infoWindow.setContent(content);
    infoWindow.open(map, item.position);
}

        function switchMode(mode) {
            currentMode = mode;
            document.getElementById('btn-freq').className = (mode === 'frequency' ? 'mode-btn active' : 'mode-btn');
            document.getElementById('btn-man').className = (mode === 'manager' ? 'mode-btn active' : 'mode-btn');
            updateDisplay();
        }

        function updateDisplay() {
            markers.forEach(m => m.setMap(null));
            markers = [];
            const selectedMan = document.getElementById('managerSelect').value;
            const legendBox = document.getElementById('legendContent');
            legendBox.innerHTML = '';

            const currentMap = (currentMode === 'frequency' ? freqColors : managerColorMap);
            Object.keys(currentMap).forEach(key => {
                const shape = (currentMode === 'frequency' ? 'dot' : 'pin-legend');
                legendBox.innerHTML += `<div class="legend-item"><div class="${shape}" style="background-color:${currentMap[key]}"></div>${key}</div>`;
            });

            rawData.forEach(item => {
                if (selectedMan !== 'å…¨éƒ¨' && item.manager !== selectedMan) return;
                let marker;
                if (currentMode === 'frequency') {
                    marker = new AMap.CircleMarker({
                        center: item.position, radius: 8,
                        fillColor: freqColors[item.frequency] || '#999',
                        strokeColor: 'white', strokeWeight: 2, fillOpacity: 0.9, map: map
                    });
                } else {
// ... åœ¨ updateDisplay å‡½æ•°çš„äººå‘˜æ¨¡å¼åˆ†æ”¯ä¸­ ...
const color = managerColorMap[item.manager] || '#666';

// ç¼©å°åçš„å°ºå¯¸å®šä¹‰ï¼š18px
const size = 18; 
const innerSize = 6; // ä¸­å¿ƒç™½ç‚¹å°ºå¯¸

marker = new AMap.Marker({
    position: item.position,
    // åç§»é‡ä¹Ÿéœ€è¦åŒæ­¥è°ƒæ•´ï¼šæ°´å¹³åç§»ä¸ºå®½åº¦çš„ä¸€åŠï¼Œå‚ç›´åç§»ä¸ºé«˜åº¦
    offset: new AMap.Pixel(-size/2, -size), 
    content: `
        <div style="position:relative;">
            <div style="
                width:${size}px; 
                height:${size}px; 
                background-color:${color}; 
                border-radius:50% 50% 50% 0; 
                transform:rotate(-45deg); 
                border:1px solid white; 
                box-shadow:0 2px 4px rgba(0,0,0,0.2);">
            </div>
            <div style="
                position:absolute; 
                width:${innerSize}px; 
                height:${innerSize}px; 
                background:white; 
                border-radius:50%; 
                top:${(size - innerSize)/2}px; 
                left:${(size - innerSize)/2}px;">
            </div>
        </div>`,
    map: map
});
                    
                }
                marker.on('click', () => openPopup(item));
                markers.push(marker);
            });
        }

        // çœ‹æ¿é€»è¾‘
        function toggleModal(show) {
            document.getElementById('statsModal').style.display = show ? 'block' : 'none';
            if(show) renderTable();
        }

        function renderTable() {
            const manF = document.getElementById('modalManagerFilter').value;
            const freqF = document.getElementById('modalFreqFilter').value;
            const tbody = document.getElementById('statsTableBody');
            let filtered = rawData.filter(d => (manF === 'å…¨éƒ¨' || d.manager === manF) && (freqF === 'å…¨éƒ¨' || d.frequency === freqF));
            
            let html = '', tRooms = 0, tTrans = 0;
            filtered.forEach(item => {
                tRooms += (parseInt(item.rooms) || 0); tTrans += (parseInt(item.transformers) || 0);
                html += `<tr><td>${item.name}</td><td>${item.manager}</td><td>${item.frequency}</td><td>${item.rooms}</td><td>${item.transformers}</td></tr>`;
            });
            tbody.innerHTML = html;
            document.getElementById('tableSummary').innerHTML = `<span>æ€»é¡¹ç›®: ${filtered.length}</span><span>æ€»é…ç”µé—´: ${tRooms}</span><span>æ€»å˜å‹å™¨: ${tTrans}</span>`;
        }
    </script>
</body>
</html>



